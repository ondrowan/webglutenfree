<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Gallery</title>
    <style>
        html,
        body {
            margin: 0px;
            padding: 0px;
            border: 0px;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: black;
        }

        iframe {
            margin: 0px;
            padding: 0px;
            border: 0px;
            position: absolute;
            top: 0px;
            left: 0px;
            display: block;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #editor {
            position: absolute;
            top: 0px;
            right: 150px;
            margin: 2px;
            padding: 0px;
            border: 2px solid green;
            width: 680px;
            height: calc(100% - 8px);
            opacity: 0.8;
            z-index: 1;
        }

        .cm-s-liquibyte.CodeMirror {
            background-color: rgb(20, 20, 20) !important;
        }

        #menu {
            position: absolute;
            top: 0px;
            right: 0px;
            margin: 2px;
            padding: 0px;
            border: 2px solid green;
            width: calc(150px - 10px);
            height: calc(100% - 8px);
            opacity: 0.8;
            z-index: 1;
            color: rgb(200, 200, 200);
            background-color: rgb(20, 20, 20);
            font-family: monospace;
            font-size: 1.2em;
        }

        #menu > div {
            margin: 5px;
            border: 1px solid grey;
            padding: 5px;
            cursor: pointer;
        }

        #menu > div:hover {
            background-color: rgb(30, 30, 30);
        }

        #menu > div:active {
            color: red;
        }

        #menu > div.selected {
            color: lawngreen;
        }
    </style>
    <link rel="stylesheet" href="./demolib/codemirror/codemirror.css"></link>
    <link rel="stylesheet" href="./demolib/codemirror/liquibyte.css"></link>
    <link rel="stylesheet" href="./demolib/codemirror/solarized.css"></link>
</head>

<body>
    <iframe id="iframe" src="sandbox.html"></iframe>
    <div id="editor"></div>
    <div id="menu">
        <div data-href="./demo/triangle.js" class="selected">triangle</div>
        <div data-href="./demo/line.js">line</div>
        <div data-href="./demo/bunny.js">bunny</div>
        <div data-href="./demo/spiral.js">spiral</div>
        <div data-href="./demo/batch.js">batch</div>
        <div data-href="./demo/shader-triangle.js">shader triangle</div>
        <div data-href="./demo/instancing.js">instancing</div>
        <div data-href="./demo/stencil.js">stencil</div>
        <div data-href="./demo/particles.js">particles</div>
        <div data-href="./demo/image-processing.js">image processing</div>
        <div data-href="./demo/persistence.js">persistence</div>
        <div data-href="./demo/bloom.js">bloom</div>
        <!-- <div data-href="./demo/context-loss.js">ctx loss</div> -->
    </div>

    <script src="./demolib/codemirror/codemirror.js"></script>
    <script src="./demolib/codemirror/javascript.js"></script>
    <script type="module">
        import { IFrame } from "./demolib/sandbox/iframe.js";
        import { debounce } from "./demolib/sandbox/util.js";

        const iframeElem = document.getElementById("iframe");
        const editorElem = document.getElementById("editor");
        const menuElem = document.getElementById("menu");

        const iframe = new IFrame("sandbox.html");
        iframe.mount(iframeElem);

        const editor = CodeMirror(editorElem, {
            mode: "javascript",
            theme: "liquibyte",
        });
        editor.setSize("100%", "100%");
        editor.on("change", debounce(500, () => {
            iframe.remount();
            iframe.postMessage({ code: editor.getValue() });
        }));

        function navigate() {
            const path = hashToPath(window.location.hash);
            const elem = document.querySelector(`[data-href="${path}"]`);
            if (elem) {
                selectElement(elem);
                fetchExample(path);
            } else {
                fetchExample("./demo/triangle.js");
            }
        }

        async function fetchExample(src) {
            const resp = await window.fetch(src);
            const code = await resp.text();
            editor.setValue(code);
        }

        function selectElement(elem) {
            document.querySelectorAll(".selected")
                .forEach(el => el.classList.remove("selected"))
            elem.classList.add("selected");
        }

        function hashToPath(hash) {
            return `./demo/${hash.substring(1)}.js`
        }

        function pathToHash(path) {
            const trimDemo = path.substring("./demo/".length);
            const trimJs = trimDemo.substring(0, trimDemo.length - ".js".length);
            return `#${trimJs}`;
        }

        menuElem.addEventListener("click", ev => {
            if (ev.target.dataset.href) {
                window.location.hash = pathToHash(ev.target.dataset.href);
            }
            ev.preventDefault();
        }, true);

        navigate();
        window.addEventListener("hashchange", _ => navigate());
    </script>
</body>

</html>
